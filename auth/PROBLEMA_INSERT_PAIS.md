# üö® Problema: Error RLS al Insertar Pa√≠s

## ‚ùå Error

```
new row violates row-level security policy for table "pais"
```

## üîç Causa del Problema

La pol√≠tica RLS de INSERT para `pais` verifica:

```sql
WITH CHECK (
    EXISTS (
        SELECT 1 
        FROM joysense.v_permiso_pais v 
        WHERE v.paisid = pais.paisid      -- ‚Üê PROBLEMA AQU√ç
          AND v.useruuid = auth.uid()
          AND v.puede_insertar = true
    )
)
```

**El problema**: Cuando insertas un **nuevo pa√≠s**, el `paisid` a√∫n no existe en `v_permiso_pais` porque:
1. El pa√≠s se inserta con un `paisid` generado autom√°ticamente
2. La pol√≠tica RLS se ejecuta **antes** de que el trigger cree el permiso
3. No encuentra el permiso ‚Üí **BLOQUEA la inserci√≥n**

## ‚úÖ Soluci√≥n

### Opci√≥n 1: Modificar Pol√≠tica RLS (RECOMENDADA)

Modificar la pol√≠tica RLS para permitir insertar si el usuario tiene permiso de insertar a nivel general (sin verificar un `paisid` espec√≠fico):

```sql
-- Eliminar pol√≠tica actual
DROP POLICY IF EXISTS rls_pais_insert ON joysense.pais;

-- Crear nueva pol√≠tica que permite insertar si el usuario tiene
-- permiso de insertar en CUALQUIER pa√≠s (o si tiene el perfil de administrador)
CREATE POLICY rls_pais_insert ON joysense.pais
FOR INSERT
WITH CHECK (
    -- Opci√≥n 1: Usuario tiene permiso de insertar en alg√∫n pa√≠s
    EXISTS (
        SELECT 1 
        FROM joysense.v_permiso_pais v 
        WHERE v.useruuid = auth.uid()
          AND v.puede_insertar = true
    )
    OR
    -- Opci√≥n 2: Usuario tiene el perfil de administrador (perfilid = 1)
    EXISTS (
        SELECT 1 
        FROM joysense.usuarioperfil up
        JOIN joysense.usuario u ON u.usuarioid = up.usuarioid
        WHERE u.useruuid = auth.uid()
          AND up.perfilid = 1
          AND up.statusid = 1
    )
);
```

**Ventajas:**
- Permite insertar nuevos pa√≠ses
- El trigger crear√° el permiso autom√°ticamente despu√©s de la inserci√≥n
- Mantiene la seguridad (solo usuarios con permisos pueden insertar)

### Opci√≥n 2: Usar Trigger BEFORE INSERT

Crear un trigger `BEFORE INSERT` que cree el permiso antes de la verificaci√≥n RLS:

```sql
CREATE OR REPLACE FUNCTION joysense.fn_auto_permiso_pais_before()
RETURNS TRIGGER AS $$
DECLARE
    v_paisid INTEGER;
BEGIN
    -- Obtener el pr√≥ximo paisid (si es GENERATED BY DEFAULT AS IDENTITY)
    -- O usar un valor temporal
    -- Esto es m√°s complejo y no recomendado
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

**Desventajas:**
- M√°s complejo
- Requiere conocer el `paisid` antes de insertar
- No es la mejor pr√°ctica

## üéØ Recomendaci√≥n Final

**Usar Opci√≥n 1** (modificar pol√≠tica RLS) porque:
- ‚úÖ Simple y directo
- ‚úÖ Mantiene la seguridad
- ‚úÖ Funciona con el trigger AFTER INSERT que ya creamos
- ‚úÖ Permite insertar nuevos pa√≠ses sin problemas

## üìù Script Completo

He actualizado `TRIGGERS_AUTO_PERMISOS.sql` para incluir el trigger de `pais`, y he creado `SOLUCION_RLS_INSERT_PAIS.sql` con la pol√≠tica RLS modificada.
