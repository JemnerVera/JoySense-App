# üîç C√≥mo se Llenan las Vistas de Permisos

## üìã Resumen

**Las vistas NO se llenan con triggers ni manualmente** - son **VISTAS** que se calculan din√°micamente bas√°ndose en datos de otras tablas.

## üîó Cadena de Dependencias

```
perfil_geografia_permiso (tabla base)
    ‚Üì
v_perfiles_geografia_final (vista intermedia)
    ‚Üì
v_permiso_pais / v_permiso_empresa / v_permiso_fundo (vistas finales)
```

## üìä Estructura de las Vistas

### 1. Vista Base: `v_perfiles_geografia_final`

```sql
CREATE OR REPLACE VIEW joysense.v_perfiles_geografia_final AS 
SELECT DISTINCT 
    u.useruuid,
    pgp.perfilid,
    pa.paisid,
    em.empresaid,
    fu.fundoid,
    ub.ubicacionid,
    pgp.puede_ver,
    pgp.puede_insertar,
    pgp.puede_actualizar
FROM joysense.usuarioperfil pu
JOIN joysense.usuario u ON u.usuarioid = pu.usuarioid
JOIN joysense.perfil_geografia_permiso pgp 
    ON pgp.perfilid = pu.perfilid 
    AND pgp.statusid = 1
LEFT JOIN joysense.pais pa ON pgp.paisid = pa.paisid
LEFT JOIN joysense.empresa em ON pgp.empresaid = em.empresaid
LEFT JOIN joysense.fundo fu ON pgp.fundoid = fu.fundoid
LEFT JOIN joysense.ubicacion ub ON pgp.ubicacionid = ub.ubicacionid
WHERE pu.statusid = 1;
```

**Esta vista:**
- Une `usuarioperfil` ‚Üí `usuario` ‚Üí `perfil_geografia_permiso`
- Obtiene el `useruuid` del usuario
- Obtiene los permisos del perfil en diferentes niveles geogr√°ficos

### 2. Vistas Espec√≠ficas

#### `v_permiso_pais`
```sql
SELECT DISTINCT useruuid, paisid, puede_ver, puede_insertar, puede_actualizar
FROM joysense.v_perfiles_geografia_final
WHERE paisid IS NOT NULL;
```

#### `v_permiso_empresa`
```sql
SELECT DISTINCT useruuid, empresaid, puede_ver, puede_insertar, puede_actualizar
FROM joysense.v_perfiles_geografia_final
WHERE empresaid IS NOT NULL;
```

#### `v_permiso_fundo`
```sql
SELECT DISTINCT useruuid, fundoid, puede_ver, puede_insertar, puede_actualizar
FROM joysense.v_perfiles_geografia_final
WHERE fundoid IS NOT NULL;
```

## üóÑÔ∏è Tabla Base: `perfil_geografia_permiso`

```sql
CREATE TABLE joysense.perfil_geografia_permiso (
    permisoid BIGINT NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    perfilid INTEGER NOT NULL,
    paisid INTEGER,           -- Solo UNO de estos puede estar lleno
    empresaid INTEGER,        -- Solo UNO de estos puede estar lleno
    fundoid INTEGER,          -- Solo UNO de estos puede estar lleno
    ubicacionid INTEGER,      -- Solo UNO de estos puede estar lleno
    puede_ver BOOLEAN DEFAULT false NOT NULL,
    puede_insertar BOOLEAN DEFAULT false NOT NULL,
    puede_actualizar BOOLEAN DEFAULT false NOT NULL,
    statusid INTEGER DEFAULT 1 NOT NULL,
    ...
);
```

**Constraint importante:**
```sql
CHECK (
    (paisid IS NOT NULL)::integer + 
    (empresaid IS NOT NULL)::integer + 
    (fundoid IS NOT NULL)::integer + 
    (ubicacionid IS NOT NULL)::integer = 1
)
```

Esto significa que **solo UNO** de los campos geogr√°ficos puede estar lleno por registro.

## üéØ Por Qu√© `v_permiso_pais` Funciona y `v_permiso_empresa`/`v_permiso_fundo` No

### Escenario Actual:

1. **`v_permiso_pais` tiene datos** porque:
   - Existe un registro en `perfil_geografia_permiso` con `paisid` lleno
   - El usuario tiene un perfil asignado en `usuarioperfil`
   - Ese perfil tiene permisos a nivel `pais`

2. **`v_permiso_empresa` est√° vac√≠a** porque:
   - NO existe ning√∫n registro en `perfil_geografia_permiso` con `empresaid` lleno
   - O el perfil del usuario no tiene permisos a nivel `empresa`

3. **`v_permiso_fundo` est√° vac√≠a** porque:
   - NO existe ning√∫n registro en `perfil_geografia_permiso` con `fundoid` lleno
   - O el perfil del usuario no tiene permisos a nivel `fundo`

## ‚úÖ Soluci√≥n: Insertar Permisos en `perfil_geografia_permiso`

Para que `v_permiso_empresa` y `v_permiso_fundo` tengan datos, necesitas:

### Opci√≥n 1: Insertar permisos espec√≠ficos por empresa/fundo

```sql
-- Obtener el perfilid del usuario administrador
SELECT perfilid 
FROM joysense.usuarioperfil up
JOIN joysense.usuario u ON u.usuarioid = up.usuarioid
WHERE u.login = 'administrador@joysense.com' 
  AND up.statusid = 1;

-- Insertar permiso a nivel empresa (reemplaza PERFIL_ID y EMPRESA_ID)
INSERT INTO joysense.perfil_geografia_permiso (
    perfilid,
    empresaid,  -- ‚Üê Nivel empresa
    puede_ver,
    puede_insertar,
    puede_actualizar,
    statusid,
    usercreatedid
) VALUES (
    PERFIL_ID,      -- ID del perfil del administrador
    EMPRESA_ID,     -- ID de la empresa
    true,           -- puede_ver
    true,           -- puede_insertar
    true,           -- puede_actualizar
    1,              -- statusid activo
    1               -- usercreatedid
);

-- Insertar permiso a nivel fundo (reemplaza PERFIL_ID y FUNDO_ID)
INSERT INTO joysense.perfil_geografia_permiso (
    perfilid,
    fundoid,    -- ‚Üê Nivel fundo
    puede_ver,
    puede_insertar,
    puede_actualizar,
    statusid,
    usercreatedid
) VALUES (
    PERFIL_ID,      -- ID del perfil del administrador
    FUNDO_ID,       -- ID del fundo
    true,           -- puede_ver
    true,           -- puede_insertar
    true,           -- puede_actualizar
    1,              -- statusid activo
    1               -- usercreatedid
);
```

### Opci√≥n 2: Query para verificar qu√© hay actualmente

```sql
-- Ver qu√© permisos tiene el perfil del administrador
SELECT 
    pgp.permisoid,
    pgp.perfilid,
    p.perfil,
    pgp.paisid,
    pgp.empresaid,
    pgp.fundoid,
    pgp.ubicacionid,
    pgp.puede_ver,
    pgp.puede_insertar,
    pgp.puede_actualizar,
    pgp.statusid
FROM joysense.perfil_geografia_permiso pgp
JOIN joysense.perfil p ON p.perfilid = pgp.perfilid
JOIN joysense.usuarioperfil up ON up.perfilid = pgp.perfilid
JOIN joysense.usuario u ON u.usuarioid = up.usuarioid
WHERE u.login = 'administrador@joysense.com'
  AND pgp.statusid = 1
  AND up.statusid = 1
ORDER BY pgp.paisid NULLS LAST, pgp.empresaid NULLS LAST, pgp.fundoid NULLS LAST;
```

## üìù Resumen

1. **Las vistas son din√°micas** - se calculan en tiempo real
2. **Dependen de `perfil_geografia_permiso`** - tabla que define permisos por perfil y nivel geogr√°fico
3. **El problema**: No hay registros en `perfil_geografia_permiso` con `empresaid` o `fundoid` llenos
4. **La soluci√≥n**: Insertar registros en `perfil_geografia_permiso` con `empresaid` y `fundoid` para el perfil del administrador
